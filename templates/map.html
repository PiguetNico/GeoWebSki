<html>
    <head>
        <meta charset="UTF-8">
        <title>Test</title>

        <!-- Leaflet CSS-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
            integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
            crossorigin=""/>

        <!-- Leaflet JavaScript -->
        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
            integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
            crossorigin=""></script>

        <!-- jQuery -->
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

        <style type="text/css">
            #swissmap
            {
                margin: 1em auto;
                width: 800px;
                height: 600px;
            }
        </style>

    </head>
    <body>


        <p>Template value for foo is <strong>{{ foo }}</strong>.</p>

        <div id="swissmap"></div>
        <div id="route_output" style="text-align: center"></div>

        <script type="text/javascript">

            // Interesting layer options to use:
            // 'subdomains' to customize which subdomains are used for parallel download
            // 'minZoom' and 'maxZoom' to limit the zoom interval in which a layer can be displayed
            // 'bounds' to limit the bounds in which a layer is displayed on the map

            // OpenTopoMap tile layer (topology added on OpenStreetMaps)
            var OpenTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            });

            // OpenStreetMaps tile layer (limited to Switzerland)
            // Unlimited tiles URL (slower!!) => 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
            var OpenStreetMap_CH = L.tileLayer('https://tile.osm.ch/switzerland/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            });

            // Stamen watercolor tile layer
            // ({s} allows to use different subdomains for parallel downloading in browsers)
            var Stamen_Watercolor = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                // by default, {s} is set to ['a','b','c']
                // but it can be customized with the 'subdomains' option
            });

            // Layers selection popup
            var tileLayers = {
                "Standard map": OpenStreetMap_CH,
                "Topology map": OpenTopoMap
                // "Watercolor": Stamen_Watercolor
            };

            var themap = L.map('swissmap', {
                // The set of layers displayed by default on the map
                layers: [OpenTopoMap],
            });
            themap.setView([46.344693, 7.139517],14);

            // Adds the layer/overlay selector
            var layersControl = L.control.layers(
                tileLayers, // base layers (radio buttons)
                null, // overlays (checkboxes)
                {
                    collapsed: false
                }
            );
            layersControl.addTo(themap);

            // Adding a scale bar on the map
            L.control.scale().addTo(themap);

            // Adding a layer manually
            // layer.addTo(map);

            // Adding a marker to represent the skier's current position
            var routePolyline = null;
            var currentPos = L.marker([46.351445, 7.157957], {draggable: true});
            currentPos.addTo( themap );
            currentPos.on(
                'dragend', function(e)
                {
                    var coords = e.target.getLatLng();

                    $.post('{{ route_change_pos }}',{lat: coords.lat, lng: coords.lng}, function(data)
                    {
                        console.log(
                            "Elevation: " + data.elevation + " meters."
                        );

                        var route_coords = [
                            [
                                data.route[0].from.location.lat,
                                data.route[0].from.location.lng
                            ]
                        ];

                        var route_steps = [];

                        for (var i = 0; i < data.route.length; i++)
                        {
                            route_coords.push(
                                [   data.route[i].to.location.lat,
                                    data.route[i].to.location.lng
                                ]
                            );

                            if ( data.route[i].through.type === 'slope' )
                            {
                                route_steps.push('Ski down <b>' + data.route[i].through.name + '</b>');
                            }

                            else if ( data.route[i].through.type === 'skilift' )
                            {
                                route_steps.push('Take lift <b>' + data.route[i].through.name + '</b>');
                            }

                            else
                            {
                                route_steps.push('<b>' + data.route[i].through.name + '</b>');
                            }
                        }

                        // Removing old route
                        if (routePolyline)
                            routePolyline.removeFrom( themap );

                        // Creating new route polyline
                        routePolyline = L.polyline(
                            route_coords,
                            {color: '#07a', opacity:0.5, weight: 20}
                        );

                        // Displaying the polyline
                        routePolyline.addTo( themap );

                        var ol = $('<ol></ol>');

                        for (var i = 0; i < route_steps.length; i++)
                        {
                            ol.append( $('<li></li>').html(route_steps[i]) );
                        }

                        $('#route_output').empty().append(ol);
                    });

                    $('#route_output').empty().append('Calculating route...');
                });





            var dataurl="{{ restaurants_geojson }}";
            var layerNormalStyle = "";
            var layerHighlightStyle = "";

            var skiOverlays = {

                'Slopes' : {
                    url: '{{ slopes_geojson }}',
                    show: true,
                    normalStyle: function (feature) {
                        return {
                            weight: 2,
                            fillOpacity: 0.3,
                            fillColor: feature.properties.color,
                            color: feature.properties.color
                        }
                    },
                    highlightStyle: function (feature) {
                        return  {
                            weight: 3,
                            fillOpacity: 0.5,
                            fillColor: feature.properties.color,
                            color: feature.properties.color
                        };
                    }
                },

                'Stopping places' : {
                    url: '{{ stoppingplaces_geojson }}',
                    normalStyle: {
                        weight: 0,
                        fillOpacity: 0.3,
                        fillColor: '#840',
                        //color: '#840'
                    },
                    highlightStyle: {
                        weight: 0,
                        fillOpacity: 0.5,
                        fillColor: '#840',
                        //color: '#840'
                    }
                },

                'Ski lifts' : {
                    url: '{{ skilifts_geojson }}',
                    show: true,
                    normalStyle: {
                        weight: 4,
                        color: '#333',
                        dashArray: '5 10'
                    },
                    highlightStyle: {
                        weight: 4,
                        color: '#333'
                    },
                    featureCallback: function(json, layer)
                    {
                        if (layer.setIcon)
                        {
                            var icon = L.icon({
                                {% load static %}
                                iconUrl: '{% static 'restaurant_marker.png' %}',
                                iconSize: [50, 66],
                                iconAnchor: [25, 66],
                                popupAnchor: [0, 0]
                            });

                            layer.setIcon( icon );
                        }
                    }
                },

                'Restaurants' : {
                    url: '{{ restaurants_geojson }}',
                    featureCallback: function(json, layer)
                    {
                        if (layer.setIcon)
                        {
                            var icon = L.icon({
                                {% load static %}
                                iconUrl: '{% static 'restaurant_marker.png' %}',
                                iconSize: [30, 39],
                                iconAnchor: [15, 39],
                                popupAnchor: [0, 0]
                            });

                            layer.setIcon( icon );
                        }
                    }
                },
            };

            for (var name in skiOverlays)
            {
                var overlay = skiOverlays[name];
                initSkiOverlay( name, overlay.show, overlay.url, overlay.normalStyle, overlay.highlightStyle, overlay.featureCallback );
            }

            function initSkiOverlay(name, show, apiUrl, normalStyle, highlightStyle, featureCallback)
            {
                // REST API call to get the restaurants
                $.getJSON(apiUrl, function (data)
                {
                    // Fetching data
                    var geojsonLayer = L.geoJson(data, {onEachFeature: addHighlightListeners});

                    if (show)
                    {
                        geojsonLayer.addTo( themap );
                    }

                    function addHighlightListeners(featureJson, featureLayer)
                    {
                        if ( typeof featureCallback === 'function' )
                        {
                            featureCallback( featureJson, featureLayer );
                        }

                        // If normal and highlight styles were defined, applies and reset them
                        // based on mouse hover
                        if ( normalStyle && highlightStyle )
                        {
                            var normal = normalStyle;
                            var highlight = highlightStyle;

                            if (typeof normalStyle == 'function')
                                normal = normalStyle( featureJson );

                            if (typeof highlightStyle == 'function')
                                highlight = highlightStyle( featureJson );


                            // Setting the polygon's style
                            if (featureLayer.setStyle)
                                featureLayer.setStyle( normal );

                            // Mouse-triggered highlighting and zooming
                            featureLayer.on({
                                mouseover: function(e) {styleAndBringToFront(highlight, e)},
                                mouseout: function(e) {e.target.setStyle(normal)},
                                click: zoomToFeature
                            });
                        }
                    }



                    // Adding the overlay to the layers control
                    layersControl.addOverlay(geojsonLayer, name);

                    // This line displays the overlay immediately
                    // geojsonLayer.addTo(themap);
                });
            }


            // Highlights the target of event e
            function styleAndBringToFront(style, e) {
                var feature = e.target;
                feature.setStyle(style);
                //feature.bringToFront();
            }

            function resetHighlight(e)
            {
                // Resets the polygon to the GeoJSON layer default styling (cannot be customized?)
                // geojsonLayer.resetStyle(e.target);

                // Line to get the feature's color
                // e.target.feature.properties.color

                // Trying to reset to the default style
                e.target.setStyle({
                    weight: 3,
                    fillOpacity: 0.2,
                    color: e.target.feature.properties.color
                });
            }

            // Zooms on a specific feature layer
            function zoomToFeature(e)
            {
                themap.fitBounds(e.target.getBounds());
            }


            // ====================================================
            // ============= Example code for popups ==============
            // ====================================================
            /*
            var popup = L.popup();

            function displayLocation(e) {
                popup
                .setLatLng(e.latlng)
                .setContent("The current location is: " + e.latlng.toString())
                .openOn(themap);
            }

            themap.on('click', displayLocation);
            */



            // ====================================================
            // ===== Example code to dynamically add polygons =====
            // ====================================================
            /*
            // Creates a marker and adds it to the map
            var marker = L.marker([46.134666, 7.62216]).addTo(themap);

            // Creates a circle and adds it to the map
            var circle = L.circle([46.7, 7.85], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 5000
            }).addTo(themap);

            // Creates a polygon and adds it to the map
            var polygon = L.polygon([
            [46.7, 7.85],
            [47.3, 7.99],
            [47.1, 8.3],
            [46.66,8.6],
            [46.51, 8.1]
            ]).addTo(themap);

            // Binds popups to the marker, circle and polygon
            marker.bindPopup("The town of Zinal in Valais").openPopup();
            circle.bindPopup("A circle near Interlaken.");
            polygon.bindPopup("The area of a new Swiss canton.");
            */

        </script>
    </body>
</html>